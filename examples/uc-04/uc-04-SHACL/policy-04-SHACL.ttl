@prefix dcterms:       <http://purl.org/dc/terms/> .
@prefix dpv:           <https://w3id.org/dpv#> .
@prefix dpv-odrl:      <https://w3id.org/dpv/mappings/odrl#> .
@prefix ehds:          <https://w3c.github.io/dpv/2.1/legal/eu/ehds/> .
@prefix ex:            <https://example.org/> .
@prefix odrl:          <http://www.w3.org/ns/odrl/2/> .
@prefix sector-health: <https://w3id.org/dpv/sector/health#> .
@prefix sh:            <http://www.w3.org/ns/shacl#> .
@prefix xsd:           <http://www.w3.org/2001/XMLSchema#> .

ex:uc04-SHACL-p-pseudonymisedweight-improvehealthcare-physicianDC-read a odrl:Set ;
    odrl:uid ex:uc04-SHACL-p-pseudonymisedweight-improvehealthcare-physicianDC-read ;
    dcterms:description "Patient allows her weight subset of health data to be read for secondary use (improving healthcare). Data must be Pseudonymised. SHACL validation."@en ;
    odrl:permission [
        odrl:action odrl:read ;
        odrl:target ex:weight-data ; # Reference to the data asset (separately defined)
        odrl:assigner ex:patient ;
        dpv:DataController ex:physician ;
        odrl:constraint [
            odrl:leftOperand dpv-odrl:Purpose ;
            odrl:operator odrl:isAnyOf ;
            odrl:rightOperand dpv:ScientificResearch, dpv:ImproveHealthcare, sector-health:ResearchDevelopment, 
                ehds:HealthcareScientificResearch, ehds:ProvideHealthcareOfficialStatistics, ehds:PublicInterestRelatedToHealth, 
                ehds:EnsureQualitySafetyHealthcare, ehds:ProtectAgainstCrossBorderThreatsToHealth, ehds:PublicHealthSurveillance ], [
            odrl:leftOperand dpv-odrl:Processing ;
            odrl:operator odrl:isA ;
            odrl:rightOperand dpv:Pseudonymisation ],[
            odrl:leftOperand dpv:hasPseudonymisationTechnique ;
            odrl:operator odrl:isAnyOf ;
            odrl:rightOperand dpv:DeterministicPseudonymisation, dpv:MonotonicCounterPseudonymisation ] ] .

### --- SHACL Validation --- ###
ex:WeightShape a sh:NodeShape ;
    sh:targetClass ex:Patient ;
    sh:property [
        sh:path ex:weight ;
        sh:datatype xsd:float ;
        sh:minCount 1 ] ;
    sh:property [
        sh:path ex:measurementDate ;
        sh:datatype xsd:date ;
        sh:minCount 1 ] ;
    sh:property [
        sh:path ex:measuredBy ;
        sh:class ehds:HealthcareProvider ;
        sh:minCount 1 ] ;
    sh:sparql [ # Checks if measurer is not a healthcare provider and reports if it isn't
        sh:select """
            SELECT $this ?date ?weight ?measurer
            WHERE {
                $this ex:weight ?weight ;
                      ex:measurementDate ?date ;
                      ex:measuredBy ?measurer .
                FILTER NOT EXISTS { ?measurer a ehds:HealthcareProvider . }
            }
        """ ;
        sh:message "Weight measurement must be recorded by a healthcare provider."@en ] .

### --- Link ODRL Target to SHACL --- ###
ex:weight-data a odrl:Asset ;
    dcterms:conformsTo ex:WeightShape .  # Indicates the data must comply with SHACL rules

#odrl:constraint [
#            odrl:leftOperand dpv:Data ;
#            odrl:operator odrl:isAnyOf ;
#            odrl:rightOperand dpv:PseudonymisedData, dpv:AnonymisedData ]
#âˆ«
#odrl:target [
#            odrl:source ex:weight ; 
#            odrl:refinement [
#                odrl:leftOperand dpv:Data ;
#                odrl:operator odrl:isAnyOf ;
#                odrl:rightOperand dpv:PseudonymisedData, dpv:AnonymisedData ]] ;
        
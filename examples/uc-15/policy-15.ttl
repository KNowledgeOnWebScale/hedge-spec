@prefix dcterms:       <http://purl.org/dc/terms/> .
@prefix dpv:           <https://w3id.org/dpv#> .
@prefix dpv-odrl:      <https://w3id.org/dpv/mappings/odrl#> .
@prefix ehds:          <https://w3c.github.io/dpv/2.1/legal/eu/ehds/> .
@prefix ex:            <https://example.org/> .
@prefix loinc:         <http://loinc.org/id/> .
@prefix odrl:          <http://www.w3.org/ns/odrl/2/> .
@prefix sector-health: <https://w3id.org/dpv/sector/health#> .
@prefix sh:            <http://www.w3.org/ns/shacl#> .
@prefix time:          <http://www.w3.org/2006/time#> .
@prefix ucum:          <http://unitsofmeasure.org/ucum.html#> .
@prefix xsd:           <http://www.w3.org/2001/XMLSchema#> .

ex:uc15-p-labresults-privatesharing-nonHCPDC-read a odrl:Set ;
    odrl:uid ex:uc15-p-labresults-privatesharing-nonHCPDC-read ;
    dcterms:description "User allows a specific glucose test result, subset of health data, to be read by a non-healthcare professional for 24h. SHACL validation."@en ;
    odrl:permission [
        odrl:action odrl:read ;
        odrl:target ex:lab-test-results-data ; # Reference to the data asset (separately defined)
        odrl:assigner ex:user15 ;
        dpv:DataSubject ex:user15 ;
        odrl:constraint [
            odrl:leftOperand dpv:Recipient ;
            odrl:operator odrl:eq ;
            odrl:rightOperand ex:nonHealthcareProfessional ], [
            odrl:leftOperand dpv-odrl:Purpose ;
            odrl:operator odrl:isAnyOf ;
            odrl:rightOperand dpv:NonCommercialPurpose, dpv:RequestedServiceProvision, sector-health:ResourceManagement, ex:SecondOpinion ], [
            odrl:leftOperand odrl:elapsedTime ;
            odrl:operator odrl:lteq ;  # Duration â‰¤ 24h
            odrl:rightOperand "P24H"^^xsd:duration ] ] .

### --- SHACL Validation --- ###
ex:LabTestResultsShape a sh:NodeShape ;
    sh:targetClass dpv:User ; # Applies to user data
    sh:property [
        # Must be a lab test result
        sh:path ex:lab-test-results ;
        sh:node ex:GlucoseTestResultShape ; # Nested shape for test details
        sh:minCount 1 ] ;
    sh:property [
        # Measurement date is required
        sh:path ex:measurementDate ;
        sh:datatype xsd:date ;
        sh:minCount 1 ;
    ] .

ex:GlucoseTestResultShape a sh:NodeShape ;
    # Specific test type (e.g., glucose)
    sh:property [
        sh:path ex:testType ;
        sh:hasValue loinc:2345-7 ;  # Glucose test (LOINC 2345-7)
        sh:minCount 1 ;
    ] ;
    # Numeric result value
    sh:property [
        sh:path ex:resultValue ;
        sh:datatype xsd:float ;
        sh:minCount 1 ;
    ] ;
    # Unit of measurement (e.g., mg/dL)
    sh:property [
        sh:path ex:resultUnit ;
        sh:hasValue "ucum:mg/dL" ;  # UCUM unit: mass/volume in plasma
        sh:minCount 1 ;
    ] .
    
### --- Link ODRL Target to SHACL --- ###
ex:lab-test-results-data a odrl:Asset ;
    dcterms:conformsTo ex:GlucoseTestResultShape .  # Indicates the data must comply with SHACL rules        